function ajax(a){var b=$.Deferred();return Ember.$.ajax({url:"json/"+a.url+".json",dataType:"jsonp",data:a.data,jsonpCallback:"callback",success:function(a){a.state?b.resolve(a.content):(alert(a.msg),b.reject(a))}}),b.promise()}function log(a){console&&console.log(a)}function alert(){$.alert.apply(null,Array.prototype.slice.call(arguments))}function initFontSize(){document.documentElement.style.fontSize=document.documentElement.clientWidth/7.5+"px"}var App=Ember.Application.create();$(function(){FastClick.attach(document.body)}),App.InputUserComponent=Ember.Component.extend({islook:!1,isReadOnly:function(){return"change"==this.get("param")}.property("param"),classname:function(){return"btn btn-big mt20 "+this.get("btnClass")}.property("btnClass"),actions:{lookpwd:function(){this.toggleProperty("islook")},click:function(){this.sendAction("action",this.get("username"),this.get("password"))}}}),App.UserInfoComponent=Ember.Component.extend({actions:{linkInfo:function(a){this.sendAction("action",a)},like:function(){var a=this,b=+new Date;this.get("item.likeCollection")||this.set("item.likeCollection",Ember.A()),this.get("item.likeCollection").pushObject({id:b}),setTimeout(function(){(a.get("item.likeCollection")||[]).forEach(function(c){c.id==b&&a.get("item.likeCollection").removeObject(c)})},3e3);var c=this.controller.get("item.publish.praises")+1;this.controller.set("item.publish.praises",c)}}}),App.LoginController=Ember.Controller.extend({password:"",username:"",actions:{login:function(){console.log(arguments);var a=this,b=this.get("username")||"",c=this.get("password")||"";return/^[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/.test(b)||/^1[3|5|7|8|][0-9]{9}$/.test(b)?c.length<6||c.length>18?(alert("密码必须在6-18个字之间"),!1):void App.User.login(b,c).done(function(c){LocalStorageCache.add("userinfo",c),LocalStorageCache.add("username",b),LocalStorageCache.add("token",c.token),c.sex&&c.area?a.transitionToRoute("friend"):(alert("请先完善资料！"),a.transitionToRoute("info"))}):(alert("用户名必须为手机号或邮箱."),!1)}}}),App.RegistController=Ember.Controller.extend({actions:{regist:function(a,b){log(arguments)}}}),App.ChangepwdController=Ember.Controller.extend({actions:{changepwd:function(a,b){var c=this;UserInfo.username=a,UserInfo.password=b,App.User.changepwd(UserInfo).done(function(){alert("修改成功",null,function(){c.transitionToRoute("info")})})}}}),App.IndexController=Ember.Controller.extend({classname:"",actions:{toggleMenu:function(){var a=this.get("classname");a?this.set("classname",""):this.set("classname","hide")}}}),App.EditController=Ember.Controller.extend({isShowSex:!1,actions:{showSex:function(){this.set("isShowSex",!0)},setSex:function(a){this.set("model.sex",a),this.set("isShowSex",!1)},cancel:function(){this.set("isShowSex",!1)}}}),App.ListIndexController=Ember.ArrayController.extend({canLoadMore:!0,ready:!1,isload:!1,pageIndex:0,List:[],actions:{start:function(){this.set("isload",!0),console.log("start")},follow:function(a){Ember.set(a,"isFollow",!0)},cancel:function(a){Ember.set(a,"isFollow",!1)},go:function(){var a=this.get("pageIndex");a++,this.set("ready",!1);var b=this;this.set("pageIndex",a),App.User.findList(a).done(function(a){var c=b.get("List").concat(a.users);b.set("List",c),b.set("content",b.get("List")),b.set("ready",!0)})}}}),App.FriendIndexController=Ember.Controller.extend({ready:!1,isload:!1,pageIndex:0,List:[],readyObserver:function(){console.log("change"),this.set("isload",!0)}.observes("ready"),actions:{start:function(){this.set("isload",!0),console.log("start")},go:function(){var a=this.get("pageIndex");a++;var b=this;this.set("pageIndex",a),App.User.findAll(a).done(function(a){var c=b.get("List").concat(a.users);b.set("List",c),b.set("model",b.get("List")),b.set("ready",!0)})},linkInfo:function(a){this.transitionToRoute("friend.personal-data",a)}}}),App.ListPersonalDataIndexController=Ember.ObjectController.extend({ispraises:!1,contentObserver:function(){if(this.get("content")){var a=(this.get("content"),this);App.User.findInfo(this.get("content.id")).done(function(b){console.log(b),a.set("userInfo",b),a.set("ispraises",b.ispraises)})}}.observes("content"),actions:{changePraises:function(){this.toggleProperty("ispraises")},linkSingle:function(a){console.log(a),this.transitionToRoute("list.personal-data.single",a)}}}),App.ListPersonalDataSingleController=Ember.ObjectController.extend({needs:["ListPersonalDataIndex"],nickname:null,avatar:null,contentObserver:function(){var a=this.get("model");this.set("item",{avatar:this.get("avatar"),nickname:this.get("nickname"),id:a.id,publish:{img:this.get("img"),desc:this.get("desc"),date:this.get("date"),praises:this.get("praises")}})}.observes("model"),actions:{linkInfo:function(a){this.transitionToRoute("list.personal-data",a)}}}),App.FriendPersonalDataIndexController=Ember.ObjectController.extend({ispraises:!1,nickname:null,avatar:null,contentObserver:function(){if(this.get("content")){var a=(this.get("content"),this);App.User.findInfo(this.get("content.id")).done(function(b){console.log(b),a.set("userInfo",b),a.set("ispraises",b.ispraises)})}}.observes("content"),actions:{changePraises:function(){this.toggleProperty("ispraises")},linkSingle:function(a){console.log(a),this.transitionToRoute("friend.personal-data.single",a)}}}),App.FriendPersonalDataSingleController=Ember.ObjectController.extend({needs:["FriendPersonalDataIndex"],nickname:null,avatar:null,contentObserver:function(){var a=this.get("model");this.set("item",{avatar:this.get("avatar"),nickname:this.get("nickname"),id:a.id,publish:{img:this.get("img"),desc:this.get("desc"),date:this.get("date"),praises:this.get("praises")}})}.observes("model"),actions:{linkInfo:function(a){this.transitionToRoute("friend.personal-data",a)}}}),App.WriteController=Ember.ObjectController.extend({img:null,content:null,uploaded:!1,actions:{bindImg:function(a){this.set("uploaded",!0),this.set("img",a)},publish:function(){var a=this;App.Info.add({img:this.get("img"),content:this.get("content")}).done(function(){a.transitionToRoute("friend")})}}}),App.CommentsController=Ember.ObjectController.extend({actions:{linkUser:function(a){this.transitionToRoute("list.personal-data.index",a)},publish:function(){this.transitionToRoute("friend")}}}),App.Model=Ember.Object.extend(),App.Model.reopenClass({find:function(a,b){var c=this.contentArrayContains(a,b);return c||(c=b.create({id:a,isLoaded:!1}),Ember.get(b,"collection").pushObject(c)),c},contentArrayContains:function(a,b){var c=Ember.get(b,"collection"),d=null;return c.forEach(function(b){return b.id==a?void(d=b):void 0}),d},findAll:function(a,b,c,d){var e=this;return ajax({url:a,data:{page:d}}).done(function(a){$.each(a[c],function(a,c){var d=e.contentArrayContains(c.id,b);d||(d=b.create(),Ember.get(b,"collection").pushObject(d)),d.setProperties(c),d.set("isLoaded",!0)})})}}),App.User=App.Model.extend(),App.User.reopenClass({collection:Ember.A(),find:function(a){return App.Model.find(a,App.User)},findInfo:function(a){return ajax({url:"userinfo",data:{id:a}}).done(function(a){})},findAll:function(a){return App.Model.findAll("user",App.User,"users",a||1)},findList:function(a){return App.Model.findAll("list",App.User,"users",a||1)},checkToken:function(){var a=$.Deferred();return LocalStorageCache.get("token").done(function(){a.resolve()}).fail(function(){a.reject()}),a.promise()},login:function(a){return ajax({url:"login",data:a}).done(function(a){})},logout:function(){LocalStorageCache.clear()},changepwd:function(a){return ajax({url:"changepwd",data:a})}}),App.Info=App.Model.extend(),App.Info.reopenClass({add:function(a){return ajax({url:"publish",type:"post",data:a})}}),App.Comment=App.Model.extend(),App.Comment.reopenClass({find:function(a){return ajax({url:"comment",data:a})}});var UserInfo={};window.alert=alert;var LocalStorage={add:function(a,b){localStorage[a]=b},remove:function(a){localStorage.removeItem(a)}};initFontSize(),$(window).on("orientationchange resize",initFontSize),Ember.Handlebars.helper("equal",function(a,b,c){return a==b?c.fn(this):c.inverse(this)}),Ember.Router.map(function(){this.resource("index",{path:"/"},function(){this.resource("info"),this.resource("list",{path:"list"},function(){this.route("personal-data",{path:"personal-data/:id"},function(){this.route("single",{path:"single/:id"})})}),this.resource("logout"),this.resource("changepwd"),this.resource("write"),this.resource("edit"),this.resource("friend",{path:"friend"},function(){this.route("personal-data",{path:"personal-data/:id"},function(){this.route("single",{path:"single/:id"})})}),this.resource("comments",{path:"comments"},function(){this.route("comment",{path:"/:id"})})}),this.route("login",{path:"login"}),this.resource("regist",{path:"regist"})}),App.IndexRoute=Ember.Route.extend({beforeModel:function(){var a=this;App.User.checkToken().fail(function(b){console.log("error"),a.transitionTo("login")}).done(function(){console.log(11)}),console.log(1)},deactivate:function(){}}),App.LoginRoute=Ember.Route.extend({model:function(){return{}},setupController:function(a,b){LocalStorageCache.get("username").done(function(b){a.set("username",b)})}}),App.InfoRoute=Ember.Route.extend({model:function(){return LocalStorageCache.get("userinfo")}}),App.EditRoute=Ember.Route.extend({model:function(){return LocalStorageCache.get("userinfo")}}),App.LogoutRoute=Ember.Route.extend({redirect:function(){App.User.logout(),this.transitionTo("login")}}),App.ChangepwdRoute=Ember.Route.extend({model:function(){console.log("change")},setupController:function(a,b){LocalStorageCache.get("username").done(function(b){a.set("username",b)})}}),App.ListIndexRoute=Ember.Route.extend({model:function(){},setupController:function(a,b){}}),App.FriendIndexRoute=Ember.Route.extend({model:function(){return[]},setupController:function(a,b){}}),App.ListPersonalDataSingleRoute=Ember.Route.extend({model:function(){this.transitionTo("list.personal-data")},setupController:function(a,b,c){var d=c.resolvedModels["list.personal-data"].userInfo;a.set("nickname",d.nickname),a.set("avatar",d.avatar),a.set("model",b)}}),App.FriendPersonalDataSingleRoute=Ember.Route.extend({model:function(){this.transitionTo("friend.personal-data")},setupController:function(a,b,c){var d=c.resolvedModels["friend.personal-data"].userInfo;a.set("nickname",d.nickname),a.set("avatar",d.avatar),a.set("model",b)}}),App.CommentsRoute=Ember.Route.extend({model:function(a){return App.Comment.find(a)}}),App.EditView=Ember.View.extend({didInsertElement:function(){var a=new Mobile_upload,b=$("#editAvatar>img");a.init({target:$("#editAvatar"),callback:function(a,c,d){b.attr("src",a)}});var c=new MobileSelectArea;c.init({trigger:$("#txt_area"),value:$("#txt_area").data("value"),data:"json/area.json"})}});var View={didInsertElement:function(){var a=this;this._scroll=function(b){a.scroll(b)};(0==this._childViews[0]._childViews.length||0==this._childViews[0]._childViews[0]._childViews.length)&&this.controller.send("go"),Ember.$(document).on("scroll",this._scroll)},willDestroyElement:function(){Ember.$(document).off("scroll",this._scroll)},scrollTop:function(){return Ember.$(document).scrollTop()},scroll:function(a){var b=this.controller.ready,c=this.scrollTop();if(b&&c){var d=document.documentElement.clientHeight;c+d==$(document).height()&&this.controller.send("go")}}};App.FriendIndexView=Ember.View.extend(View),App.ListIndexView=Ember.View.extend(View),App.WriteView=Ember.View.extend({uploaded:!0,didInsertElement:function(){var a=this;$(".txt-content").WordCount({max:300,isOverflowCut:!1,overClass:"over-number",num:$(" .counter em"),withButton:".click",minHeight:40,overflowCallback:function(){},changeCallback:function(a){},passClallback:function(){},isByte:!0});var b=new Mobile_upload;b.init({target:$(".upload-img"),callback:function(b,c,d){a.controller.send("bindImg",b)}})}});