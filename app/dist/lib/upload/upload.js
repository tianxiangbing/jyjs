!function(a,b){"function"==typeof define&&define.amd?define(["$"],b):"object"==typeof exports?module.exports=b():a.Upload=b(window.Zepto||window.jQuery||$)}(this,function(a){function b(){}return a.extend(b.prototype,{init:function(a){window.uploadCount=window.uploadCount||0,window.uploadCount++;var b=Math.random().toString().replace(".","");this.id="upload_"+b+window.uploadCount.toString(),this.settings=a,this.settings.iframe=!0,this.settings.zIndex=this.settings.zIndex||9999,this.url=this.settings.url,this.name=this.settings.name||"files",this.target=this.settings.target,this.postTarget=this.settings.postTarget,"undefined"==typeof this.settings.autoPost?this.autoPost=!0:this.autoPost=this.settings.autoPost,this.createIframe(),this.createFile(),this.bindEvent(),this.bindFileChange()},createIframe:function(){if(this.frameId="iframe_upload",0==a("#"+this.frameId).length){var b='<iframe style="display:none;" src="about:blank" id="'+this.frameId+'" name="'+this.frameId+'" width="0" height="0" frameborder="0"></iframe>';a("body").append(b)}this.frame=a("#"+this.frameId)},createFile:function(){var b=this;b.form&&b.form.remove(),b.form=a('<form method="post" ENCTYPE="multipart/form-data"><input type="file"  id="'+b.id+'" name="'+b.name+'"/></form>'),b.form.attr("target",b.frameId),b.form.css({height:0,width:0,overflow:"hidden"}),b.form.attr("action",b.url),a("body").append(b.form),b.fileInput=a("#"+b.id),b.fileInput.css({width:60,height:20,opacity:0,zIndex:b.settings.zIndex}),this.bindFileChange()},postFrame:function(b,c,d){for(var e=b.value.split("."),f=e[e.length-1],g=this,h=this.settings.accept&&this.settings.accept.split(",")||[],i=!1,j=h.length-1;j>=0;j--){var k=new RegExp(h[j],"i");k.exec(f)&&(i=!0)}if(!i&&h.length){var l="文件格式错误,支持格式："+this.settings.accept;return a.alert?a.alert(l):alert(l),!1}return g.form.submit(),g.createFile(),this.frame.off("load"),this.frame.on("load",function(){var b=a(a(this.contentWindow.document).find("body")),c=b.children()[0],e=b.html();c&&1==c.nodeType&&(e=c.innerHTML),"string"==typeof e&&"json"===g.settings.type&&(e=new Function("return "+e)()),g.settings.callback&&g.settings.callback.call(g,e,g.fileInput,g.name,g.target,d)}),!0},touch:function(b,c){function d(a){return c.call(this,a)}var e;a(b).on("click",d),a(b).on("touchmove",function(a){e=!0}).on("touchend",function(a){if(a.preventDefault(),!e){var b=c.call(this,a,"touch");b||(a.preventDefault(),a.stopPropagation())}e=!1})},bindEvent:function(b){var c,d=this;a(this.target).on("mousemove touchstart",function(b){var e;e=b.changedTouches?(b.changedTouches||b.originalEvent.changedTouches)[0]:b;var f=e.pageX-30,g=e.pageY-10;a(d.fileInput).css({left:f,top:g,position:"absolute"}),c=!0}).on("touchend",function(b){c&&(c=!1,b.preventDefault(),c||a(d.fileInput).trigger("click"),c=!1)}),d.bindFileEvent(),this.postTarget&&this.touch(a(this.postTarget),function(a,b){d.args.length&&d.postFrame.apply(d,d.args)&&d.settings.startUpload&&d.settings.startUpload.apply(d,d.args)})},bindFileEvent:function(){a(this.fileInput).click(function(a){a.stopPropagation()})},bindFileChange:function(){var b=this;a(b.fileInput).off("change"),a(b.fileInput).on("change",function(a){var c=(a.target.files,"up_"+Math.random().toString().replace(".",""));b.args=[this,a,c],b.settings.selected&&b.settings.selected.call(this,this,a,c),b.settings.iframe&&b.autoPost&&b.postFrame(this,a,c)&&b.settings.startUpload&&b.settings.startUpload(b.fileInput,b.target,c)})}}),b});